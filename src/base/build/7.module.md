---
lang: zh-CN
sidebarDepth: 2
meta:
  - name: description
    content: 个人总结的vuepress学习技术文档-语法
  - name: keywords
    content: vuepress,最新技术文档,vuepress语法,markdown语法
---
# 进程和线程
#### 进程

进程`Process`是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础，进程是线程的容器。进程是资源分配的最小单位。我们启动一个服务，运行一个实列，就是开一个服务进程，Node.js里通过`node app.js`开启一个服务进程，多进程就是复制（fork）,fork出来的每个进程都拥有自己的独立空间地址、数据栈，一个进程无法访问另一个进程里定义的变量，数据结构，只有建立IPC通信，进程之间才可以共享数据。

- Node.js中开启进程

  ```
  const http=require('http')
  const server=http.createServer()
  server.listen(3000,()=>{
  	process.title="123";
  	console.log(process.pid)
  })
  ```

#### 线程

线程是操作系统能够进行运算调度的最小单位，首先线程是属于进程的，一个进程可以有多个线程，但一个线程只能有一个进程。

##### 单线程：一个进程只开一个线程

JavaScript就是属于单线程，程序按顺序执行（先不讨论异步），上面的执行完成后才能执行下面的，当使用单线程语言编码时切勿有过多耗时的同步操作，否则线程会造成阻塞，导致线程阻塞，所以进行编码时，尽可能使用异步操作。

eg:同步任务耗时造成线程阻塞

```
const http=require('http')
const longComputation=()=>{
	let sum=0;
	for(let i=0;i<1e10;i++){
		sum +=1
	}
	return sum
}
const server=http.createServer()
server.on('request',(req,res)=>{
	if(req.url==='/compute'){
		console.log('start',new Date())
		const sum=lognComputation()
		console.log('end',new Date())
		return res.end(`Sum is ${sum}`)
	}else{
		res.end('Ok')
	}
})
server.listen(3000)
```

当我们调用`/compute`的时候，如果想调用其他的路由地址比如`/`大约需要15s时间，也可以说一个用户请求完第一个`compute`接口后需要等待15秒，这对于用户来说是极其不友好的。

单线程的一些说明

- Node.js虽然是单线程模型，但是其基于事件驱动、异步非阻塞模式，可以应用于高并发场景，避免了线程创建、线程之间上下文切换所产生的资源开销。
- 当你的项目中需要有大量计算，CPU耗时的操作的时候，要注意考虑开启多进程来完成
- Node.js开发过程中，错误会引起整个应用退出，应用的健壮性值得考验，尤其是错误的异常抛出，以及进程守护是必须做的。

- 单线程无法利用多核CPU，但是后来Node.js提供的API以及一些第三方工具相应都得到解决。

### Node.js中的进程与线程

Node.js是JavaScript在服务端的运行环境，构建在chrome的V8引擎之上，基于事件驱动、非阻塞I/O模型，充分利用操作系提供的异步I/O进行多任务的执行，适合于I/O密集型的应用场景，因为异步，程序无需阻塞等待结果返回，而是基于回调通知的机制，原本同步模式等待的时间，则可以用来处理其他任务。

在Web服务器方面，著名的Nginx也是采用此模式（事件驱动），避免了多线程的线程创建，线程上下文切换的开销

在单核CPU系统之上我们采用单进程+单线程的模式来开发。在多核CPU系统上，可以通过`child_process.fork`开启多个进程，即多进程+单线程模式。注意：开启多进程不是为了解决高并发，主要是解决了单进程模式下Node.js CPU利用率不足的情况，充分利用多核CPU的性能。

### Node.js中的进程

